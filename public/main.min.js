document.addEventListener("DOMContentLoaded",async()=>{let e=null;try{const t=await fetch("/auth/me");if(t.ok){e=(await t.json()).user}}catch(e){console.error("Auth check failed",e)}if(!e&&"/login.html"!==window.location.pathname&&"/signup.html"!==window.location.pathname)return void(window.location.href="/login.html");if(e&&("/login.html"===window.location.pathname||"/signup.html"===window.location.pathname))return void(window.location.href="/");if(!document.getElementById("app"))return;const t=io();let a={currentUser:e,currentRoomId:null,username:e?e.username:null,participants:{},files:{},openTabs:[],activeTab:null,editorInstance:null,webRTCPeers:{},localStream:null,screenStream:null,cameraTrack:null,isProgrammaticChange:!1};const n={entryModal:document.getElementById("entry-modal"),usernameInput:document.getElementById("username-input"),createRoomBtn:document.getElementById("create-room-btn"),roomIdInput:document.getElementById("room-id-input"),joinRoomBtn:document.getElementById("join-room-btn"),app:document.getElementById("app"),sidebar:document.getElementById("file-explorer-sidebar"),sidebarToggleBtn:document.getElementById("sidebar-toggle-btn"),sidebarOverlay:document.getElementById("sidebar-overlay"),fileExplorer:document.getElementById("file-explorer"),newFileBtn:document.getElementById("new-file-btn"),downloadZipBtn:document.getElementById("download-zip-btn"),tabsContainer:document.getElementById("tabs-container"),editorPane:document.getElementById("editor-pane"),editorContainer:document.getElementById("editor-container"),rightPane:document.getElementById("right-pane"),resizer:document.getElementById("resizer"),bottomPaneTabs:document.getElementById("bottom-pane-tabs"),runCodeBtn:document.getElementById("run-code-btn"),terminal:document.getElementById("terminal"),stdinInput:document.getElementById("stdin-input"),chatMessages:document.getElementById("chat-messages"),chatInput:document.getElementById("chat-input"),participantList:document.getElementById("participant-list"),videoGrid:document.getElementById("video-grid"),videoStatus:document.getElementById("video-status"),toggleMicBtn:document.getElementById("toggle-mic-btn"),toggleCamBtn:document.getElementById("toggle-cam-btn"),shareScreenBtn:document.getElementById("share-screen-btn"),activityLog:document.getElementById("activity-log"),themeToggleBtn:document.getElementById("theme-toggle-btn"),themeIconSun:document.getElementById("theme-icon-sun"),themeIconMoon:document.getElementById("theme-icon-moon"),aiMessages:document.getElementById("ai-messages"),aiInput:document.getElementById("ai-input"),sendAiBtn:document.getElementById("send-ai-btn")};function r(e){"dark"===e?(document.documentElement.classList.add("dark"),document.documentElement.classList.remove("light"),n.themeIconSun.classList.remove("hidden"),n.themeIconMoon.classList.add("hidden"),a.editorInstance&&monaco.editor.setTheme("vs-dark")):(document.documentElement.classList.add("light"),document.documentElement.classList.remove("dark"),n.themeIconSun.classList.add("hidden"),n.themeIconMoon.classList.remove("hidden"),a.editorInstance&&monaco.editor.setTheme("vs"))}function o(){const e="dark"===(document.documentElement.classList.contains("dark")?"dark":"light")?"light":"dark";localStorage.setItem("theme",e),r(e)}a.currentUser&&n.usernameInput&&(n.usernameInput.value=a.currentUser.username,n.usernameInput.disabled=!0);const s=(e,t="•")=>{const a=document.createElement("div"),r=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});a.innerHTML=`<span class="text-gray-500 dark:text-gray-400">${r}</span> <span class="text-blue-400">${t}</span> <span>${e}</span>`,n.activityLog.appendChild(a),n.activityLog.scrollTop=n.activityLog.scrollHeight},i=()=>{const e=new URLSearchParams(window.location.search).get("room");e&&(n.roomIdInput.value=e)};const c=()=>{const e=()=>{n.sidebar.classList.toggle("-translate-x-full"),n.sidebarOverlay.classList.toggle("hidden")};n.sidebarToggleBtn.addEventListener("click",e),n.sidebarOverlay.addEventListener("click",e)},d=()=>n.bottomPaneTabs.addEventListener("click",e=>{if(e.target.matches(".bottom-tab")){n.bottomPaneTabs.querySelectorAll(".bottom-tab").forEach(e=>{e.classList.remove("bg-white","dark:bg-[#1e1e1e]","border-gray-200","dark:border-gray-700/50","text-blue-600","dark:text-white","border-b-0"),e.classList.add("text-gray-600","dark:text-gray-400","hover:bg-white","dark:hover:bg-[#333]")}),e.target.classList.remove("text-gray-600","dark:text-gray-400","hover:bg-white","dark:hover:bg-[#333]"),e.target.classList.add("bg-white","dark:bg-[#1e1e1e]","border-gray-200","dark:border-gray-700/50","text-blue-600","dark:text-white","border-b-0"),document.querySelectorAll(".bottom-panel").forEach(e=>e.classList.add("hidden"));const t=document.getElementById(e.target.dataset.panel);t.classList.remove("hidden"),["chat-panel","video-panel","terminal-panel","activity-panel","ai-panel"].includes(e.target.dataset.panel)&&t.classList.add("flex","flex-col")}}),l=()=>{let e=!1;n.resizer.addEventListener("mousedown",()=>{e=!0,document.body.style.cursor="ew-resize",document.body.style.userSelect="none"}),document.addEventListener("mousemove",t=>{if(e){const e=window.innerWidth,a=t.clientX/e*100;a>20&&a<80&&(n.editorPane.style.width=`${a}%`,n.rightPane.style.width=100-a+"%")}}),document.addEventListener("mouseup",()=>{e=!1,document.body.style.cursor="default",document.body.style.userSelect="auto"})};async function m(e){const r=n.usernameInput.value.trim();if(!r)return alert("Please enter your name.");const o=e?`cs-${Math.random().toString(36).substr(2,9)}`:n.roomIdInput.value.trim();if(!o)return alert("Please enter a Room ID.");await async function(){try{n.videoStatus.textContent="Initializing camera...",a.localStream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),console.log("Local stream acquired."),a.cameraTrack=a.localStream.getVideoTracks()[0];const e=document.createElement("video");return e.srcObject=a.localStream,e.autoplay=!0,e.muted=!0,e.className="w-full h-auto bg-black rounded",n.videoGrid.prepend(e),n.videoStatus.textContent="Waiting for other participants...",a.localStream}catch(e){return console.error("Could not get user media",e),n.videoStatus.textContent="Camera/Mic access denied. Video chat is disabled.",s("Camera/Mic access denied.","Error"),null}}(),a.username=r,a.currentRoomId=o,n.entryModal.classList.add("hidden"),n.app.classList.remove("hidden"),n.app.classList.add("flex"),window.history.pushState(null,"",`?room=${o}`),t.connected&&t.emit("join-room",{roomId:a.currentRoomId,username:a.username,userId:a.currentUser?a.currentUser.id:null});const i=n.bottomPaneTabs.querySelector('[data-panel="terminal-panel"]');i&&(i.classList.remove("text-gray-600","dark:text-gray-400","hover:bg-white","dark:hover:bg-[#333]"),i.classList.add("bg-white","dark:bg-[#1e1e1e]","border-gray-200","dark:border-gray-700/50","text-blue-600","dark:text-white","border-b-0"))}const u=()=>{n.fileExplorer.innerHTML=Object.keys(a.files).sort().map(e=>`<div class="flex justify-between items-center group p-1 rounded hover:bg-black/10 dark:hover:bg-white/10 cursor-pointer" data-path="${e}">\n                <span class="file-name text-gray-700 dark:text-gray-300 group-hover:text-black dark:group-hover:text-white">${e}</span>\n                <div class="hidden group-hover:flex items-center">\n                    <button class="rename-file-btn text-xs text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white mr-1" data-path="${e}" title="Rename">Edit</button>\n                    <button class="delete-file-btn text-xs text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white" data-path="${e}" title="Delete">Del</button>\n                </div>\n            </div>`).join(""),n.fileExplorer.querySelectorAll("[data-path]").forEach(e=>e.addEventListener("click",t=>!t.target.closest("button")&&y(e.dataset.path))),n.fileExplorer.querySelectorAll(".rename-file-btn").forEach(e=>e.addEventListener("click",b)),n.fileExplorer.querySelectorAll(".delete-file-btn").forEach(e=>e.addEventListener("click",v))},g=()=>{const e=Object.values(a.participants);n.participantList.innerHTML=e.map(e=>`<div class="flex items-center space-x-3 p-2 rounded-md hover:bg-black/5 dark:hover:bg-white/5">\n                ${(e=>`<div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-sm font-bold" style="background-color: ${e.color}; color: #fff;">${e.username.charAt(0).toUpperCase()}</div>`)(e)}\n                <span class="font-medium">${e.username} ${e.id===a.currentUser?.id?'<span class="text-xs text-blue-400">(You)</span>':""}</span>\n            </div>`).join("")},p=()=>{n.tabsContainer.innerHTML=a.openTabs.map(e=>`<div class="tab flex items-center px-4 py-2 border-r border-gray-300 dark:border-gray-700/50 cursor-pointer ${e===a.activeTab?"bg-white dark:bg-[#1e1e1e]":"bg-transparent hover:bg-gray-100 dark:hover:bg-[#333]"}" data-path="${e}">\n                <span class="text-sm font-medium">${e}</span>\n                <button class="close-tab-btn ml-3 text-gray-500 hover:text-black dark:hover:text-white" data-path="${e}">×</button>\n            </div>`).join(""),n.tabsContainer.querySelectorAll(".tab").forEach(e=>e.addEventListener("click",t=>!t.target.classList.contains("close-tab-btn")&&k(e.dataset.path))),n.tabsContainer.querySelectorAll(".close-tab-btn").forEach(e=>e.addEventListener("click",t=>{t.stopPropagation(),f(e.dataset.path)}))},h=()=>{const e=prompt("Enter new file name:");e&&!a.files[e]?t.emit("file-add",{path:e}):a.files[e]&&alert("A file with that name already exists.")},b=e=>{const n=e.target.dataset.path,r=prompt("Enter new file name:",n);r&&r!==n&&!a.files[r]?t.emit("file-rename",{oldPath:n,newPath:r}):a.files[r]&&alert("A file with that name already exists.")},v=e=>{const a=e.target.dataset.path;confirm(`Delete ${a}?`)&&t.emit("file-delete",{path:a})},y=e=>{a.openTabs.includes(e)||a.openTabs.push(e),k(e)},f=e=>{a.openTabs=a.openTabs.filter(t=>t!==e),a.activeTab===e&&(a.activeTab=a.openTabs[0]||null,I(a.activeTab)),p()},k=e=>{a.activeTab=e,p(),I(e)};const I=e=>{if(!a.editorInstance)return;if(!e)return void a.editorInstance.setValue("");const t=a.editorInstance.getModel();a.isProgrammaticChange=!0,t.setValue(a.files[e]||""),monaco.editor.setModelLanguage(t,(e=>({js:"javascript",py:"python",java:"java",c:"c",cpp:"cpp",html:"html",css:"css"}[e?.split(".").pop()||""]||"plaintext"))(e)),a.isProgrammaticChange=!1},E=()=>{if(!a.activeTab)return alert("Open a file to run.");const e={js:"javascript",py:"python",java:"java",c:"c",cpp:"cpp"}[a.activeTab.split(".").pop()];if(!e)return alert(`Execution for .${a.activeTab.split(".").pop()} files is not supported.`);n.terminal.innerHTML+=`<span class="text-blue-400">> Executing ${a.activeTab}...</span>\n`,t.emit("run-code",{language:e,code:a.editorInstance.getValue(),currentFile:a.activeTab,stdin:n.stdinInput.value})},w=()=>{const e=n.aiInput.value.trim();if(!e)return;const r=a.editorInstance?a.editorInstance.getValue():"",o=document.createElement("div");o.className="text-right my-2",o.innerHTML=`<span class="bg-blue-600 text-white px-3 py-1 rounded-lg inline-block">${e}</span>`,n.aiMessages.appendChild(o),n.aiMessages.scrollTop=n.aiMessages.scrollHeight,n.aiInput.value="";const s=document.createElement("div");s.id="ai-loading",s.className="text-left my-2",s.innerHTML='<span class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded-lg inline-block italic">Thinking...</span>',n.aiMessages.appendChild(s),n.aiMessages.scrollTop=n.aiMessages.scrollHeight,t.emit("ask-ai",{message:e,context:r})};t.on("ai-response",({message:e})=>{const t=document.getElementById("ai-loading");t&&t.remove();const a=document.createElement("div");a.className="text-left my-2",a.innerHTML=`<span class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded-lg inline-block whitespace-pre-wrap">${e}</span>`,n.aiMessages.appendChild(a),n.aiMessages.scrollTop=n.aiMessages.scrollHeight});const x=()=>{const e=new JSZip;Object.keys(a.files).forEach(t=>e.file(t,a.files[t])),e.generateAsync({type:"blob"}).then(e=>{const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=`code-stream-${a.currentRoomId}.zip`,t.click()})};const T=()=>{if(!a.localStream)return;const e=!a.localStream.getAudioTracks()[0].enabled;a.localStream.getAudioTracks()[0].enabled=e,n.toggleMicBtn.classList.toggle("bg-red-600",!e),n.toggleMicBtn.classList.toggle("bg-gray-600",e)},L=()=>{if(!a.cameraTrack)return;const e=!a.cameraTrack.enabled;a.cameraTrack.enabled=e,n.toggleCamBtn.classList.toggle("bg-red-600",!e),n.toggleCamBtn.classList.toggle("bg-gray-600",e)};async function B(){if(a.screenStream)await C();else try{a.screenStream=await navigator.mediaDevices.getDisplayMedia({video:!0});const e=a.screenStream.getVideoTracks()[0];await S(e),n.shareScreenBtn.classList.add("bg-blue-600"),e.onended=()=>C()}catch(e){console.error("Screen share error:",e),s("Could not start screen share.","Screen")}}async function C(){a.cameraTrack&&(await S(a.cameraTrack),a.screenStream.getTracks().forEach(e=>e.stop()),a.screenStream=null,n.shareScreenBtn.classList.remove("bg-blue-600"))}const S=async e=>{for(const t in a.webRTCPeers){const n=a.webRTCPeers[t].getSenders().find(e=>"video"===e.track?.kind);n&&await n.replaceTrack(e)}},M=e=>{console.log(`Creating peer connection to ${e}`);const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return r.onicecandidate=a=>a.candidate&&t.emit("webrtc-ice-candidate",{to:e,candidate:a.candidate}),r.ontrack=t=>{console.log(`Received track from ${e}`);let a=document.getElementById(`video-container-${e}`);a||(a=document.createElement("div"),a.id=`video-container-${e}`,a.className="relative",a.innerHTML=`<video id="video-${e}" autoplay class="w-full h-auto bg-black rounded"></video>`,n.videoGrid.appendChild(a),n.videoStatus.textContent=""),document.getElementById(`video-${e}`).srcObject=t.streams[0]},a.localStream?.getTracks().forEach(e=>r.addTrack(e,a.localStream)),a.webRTCPeers[e]=r,r};t.on("connect",()=>{a.currentRoomId&&a.username&&t.emit("join-room",{roomId:a.currentRoomId,username:a.username,userId:a.currentUser?a.currentUser.id:null})}),t.on("initial-sync",e=>{const r=!a.editorInstance;Object.assign(a,e),u(),g(),e.chatHistory&&(n.chatMessages.innerHTML="",e.chatHistory.forEach(e=>{const t=document.createElement("div"),a=e.user.color||"#3b82f6";t.innerHTML=`<div><b style="color:${a};">${e.user.username}:</b> <span class="text-gray-700 dark:text-gray-300">${e.message}</span></div>`,n.chatMessages.appendChild(t)}),n.chatMessages.scrollTop=n.chatMessages.scrollHeight),r&&function(){if(a.editorInstance)return;const e=document.getElementById("editor");require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs"}}),require(["vs/editor/editor.main"],function(){a.editorInstance=monaco.editor.create(e,{value:"// Welcome!",language:"javascript",theme:"light"===localStorage.getItem("theme")?"vs":"vs-dark",automaticLayout:!0,fontSize:14}),a.editorInstance.onDidChangeModelContent(e=>{if(a.isProgrammaticChange)return;const n=a.editorInstance.getValue();a.files[a.activeTab]=n,1===e.changes.length&&e.changes[0].text.length>50&&t.emit("large-paste"),t.emit("code-change",{path:a.activeTab,newCode:n})});const n=Object.keys(a.files)[0];n&&y(n)})}()}),t.on("user-joined",({user:e})=>{if(a.participants[e.id]=e,g(),s(`${e.username} has joined.`,"Join"),a.localStream){const a=M(e.id);a.createOffer().then(n=>{a.setLocalDescription(n),t.emit("webrtc-offer",{to:e.id,offer:n})})}}),t.on("user-left",({userId:e})=>{const t=a.participants[e];t&&s(`${t.username} has left.`,"Left"),delete a.participants[e],g(),a.webRTCPeers[e]?.close(),delete a.webRTCPeers[e],document.getElementById(`video-container-${e}`)?.remove(),Object.keys(a.participants).length<=1&&(n.videoStatus.textContent="Waiting for other participants...")}),t.on("file-add",({path:e})=>{a.files[e]="",u()}),t.on("file-rename",({oldPath:e,newPath:t})=>{a.files[t]=a.files[e],delete a.files[e];const n=a.openTabs.indexOf(e);n>-1&&(a.openTabs[n]=t),a.activeTab===e&&(a.activeTab=t),u(),p()}),t.on("file-delete",({path:e})=>{delete a.files[e],a.activeTab===e?f(e):(a.openTabs=a.openTabs.filter(t=>t!==e),p()),u()}),t.on("code-change",({path:e,newCode:t})=>{if(a.files[e]=t,e===a.activeTab&&a.editorInstance){const e=a.editorInstance.getModel();if(e.getValue()!==t){const n=a.editorInstance.getPosition();a.isProgrammaticChange=!0,e.setValue(t),n&&a.editorInstance.setPosition(n),a.isProgrammaticChange=!1}}}),t.on("code-output",({stdout:e,stderr:t,status:a})=>{let r="";r+=t?`<span class="text-orange-400">${t.replace(/\n/g,"<br>")}</span>`:e?`<span class="text-green-400 dark:text-gray-300">Output:\n${e.replace(/\n/g,"<br>")}</span>`:`<span class="text-gray-500">Execution finished with status: ${a}</span>`,n.terminal.innerHTML+=r+"\n",n.terminal.scrollTop=n.terminal.scrollHeight}),t.on("execution-notification",({username:e,file:t})=>s(`${e} ran ${t}`,"Run")),t.on("paste-notification",({username:e})=>s(`${e} pasted a large block of code.`,"Paste")),t.on("receive-chat-message",({user:e,message:t})=>{const a=document.createElement("div");a.innerHTML=`<div><b style="color:${e.color};">${e.username}:</b> <span class="text-gray-700 dark:text-gray-300">${t}</span></div>`,n.chatMessages.appendChild(a),n.chatMessages.scrollTop=n.chatMessages.scrollHeight}),t.on("webrtc-offer",async({from:e,offer:a})=>{const n=M(e);await n.setRemoteDescription(new RTCSessionDescription(a));const r=await n.createAnswer();await n.setLocalDescription(r),t.emit("webrtc-answer",{to:e,answer:r})}),t.on("webrtc-answer",({from:e,answer:t})=>a.webRTCPeers[e]?.setRemoteDescription(new RTCSessionDescription(t))),t.on("webrtc-ice-candidate",({from:e,candidate:t})=>a.webRTCPeers[e]?.addIceCandidate(new RTCIceCandidate(t))),n.createRoomBtn.addEventListener("click",()=>m(!0)),n.joinRoomBtn.addEventListener("click",()=>m(!1)),n.newFileBtn.addEventListener("click",h),n.downloadZipBtn.addEventListener("click",x),n.runCodeBtn.addEventListener("click",E),n.chatInput.addEventListener("keypress",e=>{"Enter"===e.key&&""!==n.chatInput.value.trim()&&(t.emit("send-chat-message",{message:n.chatInput.value.trim()}),n.chatInput.value="")}),n.toggleMicBtn.addEventListener("click",T),n.toggleCamBtn.addEventListener("click",L),n.shareScreenBtn.addEventListener("click",B),n.themeToggleBtn.addEventListener("click",o),n.sendAiBtn.addEventListener("click",w),n.aiInput.addEventListener("keypress",e=>{"Enter"===e.key&&w()}),d(),l(),c(),i(),r(localStorage.getItem("theme")||"dark")});