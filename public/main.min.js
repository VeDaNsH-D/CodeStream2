document.addEventListener("DOMContentLoaded",(()=>{const e=io();let t={currentUser:null,currentRoomId:null,username:null,participants:{},files:{},openTabs:[],activeTab:null,editorInstance:null,webRTCPeers:{},localStream:null,screenStream:null,cameraTrack:null,isProgrammaticChange:!1};const a={entryModal:document.getElementById("entry-modal"),usernameInput:document.getElementById("username-input"),createRoomBtn:document.getElementById("create-room-btn"),roomIdInput:document.getElementById("room-id-input"),joinRoomBtn:document.getElementById("join-room-btn"),app:document.getElementById("app"),sidebar:document.getElementById("file-explorer-sidebar"),sidebarToggleBtn:document.getElementById("sidebar-toggle-btn"),sidebarOverlay:document.getElementById("sidebar-overlay"),fileExplorer:document.getElementById("file-explorer"),newFileBtn:document.getElementById("new-file-btn"),downloadZipBtn:document.getElementById("download-zip-btn"),tabsContainer:document.getElementById("tabs-container"),editorPane:document.getElementById("editor-pane"),editorContainer:document.getElementById("editor-container"),rightPane:document.getElementById("right-pane"),resizer:document.getElementById("resizer"),bottomPaneTabs:document.getElementById("bottom-pane-tabs"),runCodeBtn:document.getElementById("run-code-btn"),terminal:document.getElementById("terminal"),stdinInput:document.getElementById("stdin-input"),chatMessages:document.getElementById("chat-messages"),chatInput:document.getElementById("chat-input"),participantList:document.getElementById("participant-list"),videoGrid:document.getElementById("video-grid"),videoStatus:document.getElementById("video-status"),toggleMicBtn:document.getElementById("toggle-mic-btn"),toggleCamBtn:document.getElementById("toggle-cam-btn"),shareScreenBtn:document.getElementById("share-screen-btn"),activityLog:document.getElementById("activity-log"),themeToggleBtn:document.getElementById("theme-toggle-btn"),themeIconSun:document.getElementById("theme-icon-sun"),themeIconMoon:document.getElementById("theme-icon-moon"),aiMessages:document.getElementById("ai-messages"),aiInput:document.getElementById("ai-input"),sendAiBtn:document.getElementById("send-ai-btn")};function n(e){"dark"===e?(document.documentElement.classList.add("dark"),document.documentElement.classList.remove("light"),a.themeIconSun.classList.remove("hidden"),a.themeIconMoon.classList.add("hidden"),t.editorInstance&&monaco.editor.setTheme("vs-dark")):(document.documentElement.classList.add("light"),document.documentElement.classList.remove("dark"),a.themeIconSun.classList.add("hidden"),a.themeIconMoon.classList.remove("hidden"),t.editorInstance&&monaco.editor.setTheme("vs"))}function r(){const e="dark"===(document.documentElement.classList.contains("dark")?"dark":"light")?"light":"dark";localStorage.setItem("theme",e),n(e)}const o=(e,t="•")=>{const n=document.createElement("div"),r=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});n.innerHTML=`<span class="text-gray-500 dark:text-gray-400">${r}</span> <span class="text-blue-400">${t}</span> <span>${e}</span>`,a.activityLog.appendChild(n),a.activityLog.scrollTop=a.activityLog.scrollHeight},s=()=>{const e=new URLSearchParams(window.location.search).get("room");e&&(a.roomIdInput.value=e)};const i=()=>{const e=()=>{a.sidebar.classList.toggle("-translate-x-full"),a.sidebarOverlay.classList.toggle("hidden")};a.sidebarToggleBtn.addEventListener("click",e),a.sidebarOverlay.addEventListener("click",e)},c=()=>a.bottomPaneTabs.addEventListener("click",(e=>{if(e.target.matches(".bottom-tab")){a.bottomPaneTabs.querySelectorAll(".bottom-tab").forEach((e=>{e.classList.remove("bg-white","dark:bg-[#1e1e1e]","border-gray-200","dark:border-gray-700/50","text-blue-600","dark:text-white","border-b-0"),e.classList.add("text-gray-600","dark:text-gray-400","hover:bg-white","dark:hover:bg-[#333]")})),e.target.classList.remove("text-gray-600","dark:text-gray-400","hover:bg-white","dark:hover:bg-[#333]"),e.target.classList.add("bg-white","dark:bg-[#1e1e1e]","border-gray-200","dark:border-gray-700/50","text-blue-600","dark:text-white","border-b-0"),document.querySelectorAll(".bottom-panel").forEach((e=>e.classList.add("hidden")));const t=document.getElementById(e.target.dataset.panel);t.classList.remove("hidden"),["chat-panel","video-panel","terminal-panel","activity-panel","ai-panel"].includes(e.target.dataset.panel)&&t.classList.add("flex","flex-col")}})),d=()=>{let e=!1;a.resizer.addEventListener("mousedown",(()=>{e=!0,document.body.style.cursor="ew-resize",document.body.style.userSelect="none"})),document.addEventListener("mousemove",(t=>{if(e){const e=window.innerWidth,n=t.clientX/e*100;n>20&&n<80&&(a.editorPane.style.width=`${n}%`,a.rightPane.style.width=100-n+"%")}})),document.addEventListener("mouseup",(()=>{e=!1,document.body.style.cursor="default",document.body.style.userSelect="auto"}))};async function l(n){const r=a.usernameInput.value.trim();if(!r)return alert("Please enter your name.");const s=n?`cs-${Math.random().toString(36).substr(2,9)}`:a.roomIdInput.value.trim();if(!s)return alert("Please enter a Room ID.");await async function(){try{a.videoStatus.textContent="Initializing camera...",t.localStream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),console.log("Local stream acquired."),t.cameraTrack=t.localStream.getVideoTracks()[0];const e=document.createElement("video");return e.srcObject=t.localStream,e.autoplay=!0,e.muted=!0,e.className="w-full h-auto bg-black rounded",a.videoGrid.prepend(e),a.videoStatus.textContent="Waiting for other participants...",t.localStream}catch(e){return console.error("Could not get user media",e),a.videoStatus.textContent="Camera/Mic access denied. Video chat is disabled.",o("Camera/Mic access denied.","Error"),null}}(),t.username=r,t.currentRoomId=s,a.entryModal.classList.add("hidden"),a.app.classList.remove("hidden"),a.app.classList.add("flex"),window.history.pushState(null,"",`?room=${s}`),e.connected&&e.emit("join-room",{roomId:t.currentRoomId,username:t.username});const i=a.bottomPaneTabs.querySelector('[data-panel="terminal-panel"]');i&&(i.classList.remove("text-gray-600","dark:text-gray-400","hover:bg-white","dark:hover:bg-[#333]"),i.classList.add("bg-white","dark:bg-[#1e1e1e]","border-gray-200","dark:border-gray-700/50","text-blue-600","dark:text-white","border-b-0"))}const m=()=>{a.fileExplorer.innerHTML=Object.keys(t.files).sort().map((e=>`<div class="flex justify-between items-center group p-1 rounded hover:bg-black/10 dark:hover:bg-white/10 cursor-pointer" data-path="${e}">\n                <span class="file-name text-gray-700 dark:text-gray-300 group-hover:text-black dark:group-hover:text-white">${e}</span>\n                <div class="hidden group-hover:flex items-center">\n                    <button class="rename-file-btn text-xs text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white mr-1" data-path="${e}" title="Rename">Edit</button>\n                    <button class="delete-file-btn text-xs text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white" data-path="${e}" title="Delete">Del</button>\n                </div>\n            </div>`)).join(""),a.fileExplorer.querySelectorAll("[data-path]").forEach((e=>e.addEventListener("click",(t=>!t.target.closest("button")&&v(e.dataset.path))))),a.fileExplorer.querySelectorAll(".rename-file-btn").forEach((e=>e.addEventListener("click",b))),a.fileExplorer.querySelectorAll(".delete-file-btn").forEach((e=>e.addEventListener("click",h)))},g=()=>{const e=Object.values(t.participants);a.participantList.innerHTML=e.map((e=>`<div class="flex items-center space-x-3 p-2 rounded-md hover:bg-black/5 dark:hover:bg-white/5">\n                ${(e=>`<div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-sm font-bold" style="background-color: ${e.color}; color: #fff;">${e.username.charAt(0).toUpperCase()}</div>`)(e)}\n                <span class="font-medium">${e.username} ${e.id===t.currentUser?.id?'<span class="text-xs text-blue-400">(You)</span>':""}</span>\n            </div>`)).join("")},u=()=>{a.tabsContainer.innerHTML=t.openTabs.map((e=>`<div class="tab flex items-center px-4 py-2 border-r border-gray-300 dark:border-gray-700/50 cursor-pointer ${e===t.activeTab?"bg-white dark:bg-[#1e1e1e]":"bg-transparent hover:bg-gray-100 dark:hover:bg-[#333]"}" data-path="${e}">\n                <span class="text-sm font-medium">${e}</span>\n                <button class="close-tab-btn ml-3 text-gray-500 hover:text-black dark:hover:text-white" data-path="${e}">×</button>\n            </div>`)).join(""),a.tabsContainer.querySelectorAll(".tab").forEach((e=>e.addEventListener("click",(t=>!t.target.classList.contains("close-tab-btn")&&f(e.dataset.path))))),a.tabsContainer.querySelectorAll(".close-tab-btn").forEach((e=>e.addEventListener("click",(t=>{t.stopPropagation(),y(e.dataset.path)}))))},p=()=>{const a=prompt("Enter new file name:");a&&!t.files[a]?e.emit("file-add",{path:a}):t.files[a]&&alert("A file with that name already exists.")},b=a=>{const n=a.target.dataset.path,r=prompt("Enter new file name:",n);r&&r!==n&&!t.files[r]?e.emit("file-rename",{oldPath:n,newPath:r}):t.files[r]&&alert("A file with that name already exists.")},h=t=>{const a=t.target.dataset.path;confirm(`Delete ${a}?`)&&e.emit("file-delete",{path:a})},v=e=>{t.openTabs.includes(e)||t.openTabs.push(e),f(e)},y=e=>{t.openTabs=t.openTabs.filter((t=>t!==e)),t.activeTab===e&&(t.activeTab=t.openTabs[0]||null,k(t.activeTab)),u()},f=e=>{t.activeTab=e,u(),k(e)};const k=e=>{if(!t.editorInstance)return;if(!e)return void t.editorInstance.setValue("");const a=t.editorInstance.getModel();t.isProgrammaticChange=!0,a.setValue(t.files[e]||""),monaco.editor.setModelLanguage(a,(e=>({js:"javascript",py:"python",java:"java",c:"c",cpp:"cpp",html:"html",css:"css"}[e?.split(".").pop()||""]||"plaintext"))(e)),t.isProgrammaticChange=!1},E=()=>{if(!t.activeTab)return alert("Open a file to run.");const n={js:"javascript",py:"python",java:"java",c:"c",cpp:"cpp"}[t.activeTab.split(".").pop()];if(!n)return alert(`Execution for .${t.activeTab.split(".").pop()} files is not supported.`);a.terminal.innerHTML+=`<span class="text-blue-400">> Executing ${t.activeTab}...</span>\n`,e.emit("run-code",{language:n,code:t.editorInstance.getValue(),currentFile:t.activeTab,stdin:a.stdinInput.value})},I=()=>{const n=a.aiInput.value.trim();if(!n)return;const r=t.editorInstance?t.editorInstance.getValue():"",o=document.createElement("div");o.className="text-right my-2",o.innerHTML=`<span class="bg-blue-600 text-white px-3 py-1 rounded-lg inline-block">${n}</span>`,a.aiMessages.appendChild(o),a.aiMessages.scrollTop=a.aiMessages.scrollHeight,a.aiInput.value="";const s=document.createElement("div");s.id="ai-loading",s.className="text-left my-2",s.innerHTML='<span class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded-lg inline-block italic">Thinking...</span>',a.aiMessages.appendChild(s),a.aiMessages.scrollTop=a.aiMessages.scrollHeight,e.emit("ask-ai",{message:n,context:r})};e.on("ai-response",(({message:e})=>{const t=document.getElementById("ai-loading");t&&t.remove();const n=document.createElement("div");n.className="text-left my-2",n.innerHTML=`<span class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded-lg inline-block whitespace-pre-wrap">${e}</span>`,a.aiMessages.appendChild(n),a.aiMessages.scrollTop=a.aiMessages.scrollHeight}));const x=()=>{const e=new JSZip;Object.keys(t.files).forEach((a=>e.file(a,t.files[a]))),e.generateAsync({type:"blob"}).then((e=>{const a=document.createElement("a");a.href=URL.createObjectURL(e),a.download=`code-stream-${t.currentRoomId}.zip`,a.click()}))};const w=()=>{if(!t.localStream)return;const e=!t.localStream.getAudioTracks()[0].enabled;t.localStream.getAudioTracks()[0].enabled=e,a.toggleMicBtn.classList.toggle("bg-red-600",!e),a.toggleMicBtn.classList.toggle("bg-gray-600",e)},T=()=>{if(!t.cameraTrack)return;const e=!t.cameraTrack.enabled;t.cameraTrack.enabled=e,a.toggleCamBtn.classList.toggle("bg-red-600",!e),a.toggleCamBtn.classList.toggle("bg-gray-600",e)};async function L(){if(t.screenStream)await B();else try{t.screenStream=await navigator.mediaDevices.getDisplayMedia({video:!0});const e=t.screenStream.getVideoTracks()[0];await S(e),a.shareScreenBtn.classList.add("bg-blue-600"),e.onended=()=>B()}catch(e){console.error("Screen share error:",e),o("Could not start screen share.","Screen")}}async function B(){t.cameraTrack&&(await S(t.cameraTrack),t.screenStream.getTracks().forEach((e=>e.stop())),t.screenStream=null,a.shareScreenBtn.classList.remove("bg-blue-600"))}const S=async e=>{for(const a in t.webRTCPeers){const n=t.webRTCPeers[a].getSenders().find((e=>"video"===e.track?.kind));n&&await n.replaceTrack(e)}},C=n=>{console.log(`Creating peer connection to ${n}`);const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return r.onicecandidate=t=>t.candidate&&e.emit("webrtc-ice-candidate",{to:n,candidate:t.candidate}),r.ontrack=e=>{console.log(`Received track from ${n}`);let t=document.getElementById(`video-container-${n}`);t||(t=document.createElement("div"),t.id=`video-container-${n}`,t.className="relative",t.innerHTML=`<video id="video-${n}" autoplay class="w-full h-auto bg-black rounded"></video>`,a.videoGrid.appendChild(t),a.videoStatus.textContent=""),document.getElementById(`video-${n}`).srcObject=e.streams[0]},t.localStream?.getTracks().forEach((e=>r.addTrack(e,t.localStream))),t.webRTCPeers[n]=r,r};e.on("connect",(()=>{t.currentRoomId&&t.username&&e.emit("join-room",{roomId:t.currentRoomId,username:t.username})})),e.on("initial-sync",(a=>{const n=!t.editorInstance;Object.assign(t,a),m(),g(),n&&function(){if(t.editorInstance)return;const a=document.getElementById("editor");require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs"}}),require(["vs/editor/editor.main"],(function(){t.editorInstance=monaco.editor.create(a,{value:"// Welcome!",language:"javascript",theme:"light"===localStorage.getItem("theme")?"vs":"vs-dark",automaticLayout:!0,fontSize:14}),t.editorInstance.onDidChangeModelContent((a=>{if(t.isProgrammaticChange)return;const n=t.editorInstance.getValue();t.files[t.activeTab]=n,1===a.changes.length&&a.changes[0].text.length>50&&e.emit("large-paste"),e.emit("code-change",{path:t.activeTab,newCode:n})}));const n=Object.keys(t.files)[0];n&&v(n)}))}()})),e.on("user-joined",(({user:a})=>{if(t.participants[a.id]=a,g(),o(`${a.username} has joined.`,"Join"),t.localStream){const t=C(a.id);t.createOffer().then((n=>{t.setLocalDescription(n),e.emit("webrtc-offer",{to:a.id,offer:n})}))}})),e.on("user-left",(({userId:e})=>{const n=t.participants[e];n&&o(`${n.username} has left.`,"Left"),delete t.participants[e],g(),t.webRTCPeers[e]?.close(),delete t.webRTCPeers[e],document.getElementById(`video-container-${e}`)?.remove(),Object.keys(t.participants).length<=1&&(a.videoStatus.textContent="Waiting for other participants...")})),e.on("file-add",(({path:e})=>{t.files[e]="",m()})),e.on("file-rename",(({oldPath:e,newPath:a})=>{t.files[a]=t.files[e],delete t.files[e];const n=t.openTabs.indexOf(e);n>-1&&(t.openTabs[n]=a),t.activeTab===e&&(t.activeTab=a),m(),u()})),e.on("file-delete",(({path:e})=>{delete t.files[e],t.activeTab===e?y(e):(t.openTabs=t.openTabs.filter((t=>t!==e)),u()),m()})),e.on("code-change",(({path:e,newCode:a})=>{if(t.files[e]=a,e===t.activeTab&&t.editorInstance){const e=t.editorInstance.getModel();if(e.getValue()!==a){const n=t.editorInstance.getPosition();t.isProgrammaticChange=!0,e.setValue(a),n&&t.editorInstance.setPosition(n),t.isProgrammaticChange=!1}}})),e.on("code-output",(({stdout:e,stderr:t,status:n})=>{let r="";r+=t?`<span class="text-orange-400">${t.replace(/\n/g,"<br>")}</span>`:e?`<span class="text-green-400 dark:text-gray-300">Output:\n${e.replace(/\n/g,"<br>")}</span>`:`<span class="text-gray-500">Execution finished with status: ${n}</span>`,a.terminal.innerHTML+=r+"\n",a.terminal.scrollTop=a.terminal.scrollHeight})),e.on("execution-notification",(({username:e,file:t})=>o(`${e} ran ${t}`,"Run"))),e.on("paste-notification",(({username:e})=>o(`${e} pasted a large block of code.`,"Paste"))),e.on("receive-chat-message",(({user:e,message:t})=>{const n=document.createElement("div");n.innerHTML=`<div><b style="color:${e.color};">${e.username}:</b> <span class="text-gray-700 dark:text-gray-300">${t}</span></div>`,a.chatMessages.appendChild(n),a.chatMessages.scrollTop=a.chatMessages.scrollHeight})),e.on("webrtc-offer",(async({from:t,offer:a})=>{const n=C(t);await n.setRemoteDescription(new RTCSessionDescription(a));const r=await n.createAnswer();await n.setLocalDescription(r),e.emit("webrtc-answer",{to:t,answer:r})})),e.on("webrtc-answer",(({from:e,answer:a})=>t.webRTCPeers[e]?.setRemoteDescription(new RTCSessionDescription(a)))),e.on("webrtc-ice-candidate",(({from:e,candidate:a})=>t.webRTCPeers[e]?.addIceCandidate(new RTCIceCandidate(a)))),a.createRoomBtn.addEventListener("click",(()=>l(!0))),a.joinRoomBtn.addEventListener("click",(()=>l(!1))),a.newFileBtn.addEventListener("click",p),a.downloadZipBtn.addEventListener("click",x),a.runCodeBtn.addEventListener("click",E),a.chatInput.addEventListener("keypress",(t=>{"Enter"===t.key&&""!==a.chatInput.value.trim()&&(e.emit("send-chat-message",{message:a.chatInput.value.trim()}),a.chatInput.value="")})),a.toggleMicBtn.addEventListener("click",w),a.toggleCamBtn.addEventListener("click",T),a.shareScreenBtn.addEventListener("click",L),a.themeToggleBtn.addEventListener("click",r),a.sendAiBtn.addEventListener("click",I),a.aiInput.addEventListener("keypress",(e=>{"Enter"===e.key&&I()})),c(),d(),i(),s(),n(localStorage.getItem("theme")||"dark")}));